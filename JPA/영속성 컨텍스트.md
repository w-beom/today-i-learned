# 영속성 컨텍스트
# JPA에서 가장 중요한 2가지

- 객체와 관계형 데이터베이스 매핑하기 (Object Relational Mapping)
- **영속성 컨텍스트**

## 영속성 컨텍스트

- JPA를 이해하는데 가장 중요한 용어
- 엔티티를 영구 저장하는 환경 이라는 뜻
- EntityManager.persist(entity);
- 영속성 컨텍스트는 논리적인 개념
- 눈에 보이지 않는다.
- 엔티티 매니저를 통해서 영속성 컨텍스트에 접근

## 엔티티의 생명주기

- 비영속 (new/transient)
    
    영속성 컨텍스트와 전혀 관계가 없는 `새로운` 상태
    
    ```java
    // 아래처럼 객체를 새로 생성한 상태
    Member member = new Member();
    member.setId("member1");
    member.setUserName("회원1");
    ```
    
- 영속 (manager)
    
    영속성 컨텍스트에 `관리`되는 상태
    
    ```java
    Member member = new Member();
    member.setId("member1");
    member.setUserName("회원1");
    
    EntityManager em = emf.createEntityManager();
    em.getTransaction().begin();
    
    // 객체를 저장한 상태(영속)
    em.persist(member);
    ```
    
    엔티티가 영속상태가 된다고 해서 sql이 날라가는게 아니다. 트랜잭션 커밋을 해야 sql이 발생함
    
- 준영속 (detached)
    
    영속성 컨텍스트에 저장되었다가 `분리`된 상태
    
    ```java
    Member member = new Member();
    member.setId("member1");
    member.setUserName("회원1");
    
    EntityManager em = emf.createEntityManager();
    em.getTransaction().begin();
    
    // 객체를 저장한 상태(영속)
    em.persist(member);
    
    // 준영속 상태 (영속성 컨텍스트에서 엔티티를 꺼냄)
    em.detach(member);
    ```
    
- 삭제 (removed)
    
    `삭제`된 상태
    

## 영속성 컨텍스트의 이점

- 1차캐시
    
    엔티티를 영속화 시키면 영속성 컨텍스트에 저장해 놓는다.
    
    - key는 엔티티의 primary key로 value는 엔티티를 저장한다.
    1. 엔티티 매니저를 통해 영속성 컨텍스트에 접근해 엔티티를 찾는다. (1차 캐시)
    2. 있으면 해당 엔티티를 반환
    3. 없으면 데이터베이스에 접근해 데이터를 가져온 후 영속성 컨텍스트에 엔티티를 저장한다.
    4. 엔티티 반환
- 동일성(identity) 보장
    
    영속 엔티티의 동일성을 보장한다.
    
    ```java
    Member a = entityManager.find(Member.class, "member1");
    Member b = entityManager.find(Member.class, "member2");
    
    System.out.println(a == b); // 동일성 비교 true
    ```
    
- 트랜잭션을 지원하는 쓰기 지연
    
    (transactional write-behind)
    
- 변경 감지(Dirty Checking)
- 지연 로딩(Lazy Loading)